<!DOCTYPE html>
<meta charset="utf-8">
<head>
    <title>Simple Map of Visited Places</title>
    <script src="d3/d3.v3.min.js"></script>
    <script src="d3/topojson.v1.min.js"></script>
    <script src="datamaps/datamaps.world.hires.min.js"></script>
    <!-- optional: delete 'hires' to show a low res map (not recommend)-->
    <style>
        svg {
            overflow: hidden;
        }
        .hoverinfo {
            position: absolute;
            background: white;
            border: 1px solid gray;
            padding: 5px;
            border-radius: 5px;
            pointer-events: none;
            font-size: 12px;
            z-index: 1000;
        }
    
        /* Map container fills the full viewport height */
        #visited_map {
            position: relative;
            width: 100%;
            height: 100%;        /* You can change this to 80vh or similar */
            background-color: #dbedff;  /* Light blue background as requested */
        }
    
        /* Make the Datamaps-generated SVG fill the container */
        #visited_map svg {
            width: 100%;
            height: 100%;
            display: block;       /* Remove extra gaps to avoid white bars */
        }
        /* Legend container appearance */
        .legend {
            position: absolute;
            bottom: 80px;              /* Adjust as needed for preferred position */
            left: 20px;
            background: rgba(255, 255, 255, 0.85);
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 14px;
            line-height: 20px;
            z-index: 2000;          /* Higher than .hoverinfo (1000) */
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        /* Legend color markers */
        .legend .color {
            display: inline-block;
            width: 16px;
            height: 16px;
            margin-right: 6px;
            border-radius: 3px;
            vertical-align: middle;
        }

        /* Colors correspond to each fillKey */
        .legend .lived { background: #1E90FF; }
        .legend .stayed { background: #90E0BE; }
        .legend .visited { background: #F14C4C; }
        .legend .passed_through { background: #F0F0F0; }
        .legend .plan { background: #FFF400; }

    </style>
</head>
<body>
    <h1>Visited Places</h1>
    <div id="visited_map"></div>
    <div id="legend" class="legend">
        <div><span class="color lived"></span> Lived (> 3 month)</div>
        <div><span class="color stayed"></span> Stayed (> 1 week)</div>
        <div><span class="color visited"></span> Visited</div>
        <div><span class="color passed_through"></span> Passed through</div>
        <div><span class="color plan"></span> Plan</div>
    </div>
    

    <script src="countries.js"></script>
    <script src="cities.js"></script>

    <script>
    // Create the map
    var map = new Datamap({
        scope: 'world',
        element: document.getElementById('visited_map'),
        projection: 'mercator',
        responsive: true,
        fills: {
            defaultFill: '#D0D0D0',

            country_visited: '#A0C0A0',
            country_planning:'#FFE680',
            
            city_lived: '#1E90FF', // Blue
            city_stayed: '#90E0BE', // Green
            city_visited: '#F14C4C', // Red
            city_passed_through: '#F0F0F0', // Grey
            city_planning:'#FFF400', //Yellow
            // city: '#FC8050'
        },
        geographyConfig: {
            highlightOnHover: true,
            highlightFillColor: 'A0A0A0', 
            // no # before A0A0A0 on purpose, because highlight colors might cause misunderstanding
            highlightBorderColor: '#F0F0F0',
            popupOnHover: true,
            popupTemplate: function(geography, data) {
                return '<div class="hoverinfo"><b>' + geography.properties.name + '</b></div>';
            },
        },
        data: COUNTRIES
    });

    // Append the cities and the map to separate groups for zooming
    var svg = d3.select('#visited_map').select('svg');
    var gMap = svg.append('g'); // Group for world map
    var gCities = svg.append('g'); // Separate group for cities (above the map)

    // Move all map paths into the map group
    svg.selectAll('.datamaps-subunit').each(function() {
        gMap.node().appendChild(this);
    });

    // Add cities to their separate group
    function drawCities() {
        return gCities.selectAll('.city')
            .data(CITIES)
            .enter()
            .append('circle')
            .attr('class', 'city')
            .attr('r', d => d.radius)
            .attr('fill', d => map.options.fills[d.fillKey])
            .attr('cx', d => map.latLngToXY(d.latitude, d.longitude)[0])
            .attr('cy', d => map.latLngToXY(d.latitude, d.longitude)[1])
            .on('mouseover', function(d) {
                // Add hover functionality
                d3.select(this).attr('stroke', 'black').attr('stroke-width', 2);
                var tooltip = d3.select('body').append('div')
                    .attr('class', 'hoverinfo')
                    .style('left', (d3.event.pageX + 10) + 'px')
                    .style('top', (d3.event.pageY + 10) + 'px')
                    .html(d.name + ': ' + d.date);

                d3.select(this).on('mousemove', function() {
                    tooltip
                        .style('left', (d3.event.pageX + 10) + 'px')
                        .style('top', (d3.event.pageY + 10) + 'px');
                });

                d3.select(this).on('mouseout', function() {
                    tooltip.remove();
                    d3.select(this).attr('stroke', null);
                });
            });
    }

    var cities = drawCities();

    // Enable zooming and panning
    var zoom = d3.behavior.zoom()
        .scaleExtent([1, 10]) // Zoom levels
        .on('zoom', function() {
            gMap.attr('transform', 'translate(' + d3.event.translate + ')scale(' + d3.event.scale + ')');
            // Apply transform to cities for positioning, but adjust radius inversely to keep dots constant size
            gCities.attr('transform', 'translate(' + d3.event.translate + ')scale(' + d3.event.scale + ')');
            // Apply inverse scale to radius to counteract the group scaling
            gCities.selectAll('.city')
                .attr('r', d => d.radius / d3.event.scale);
        });

    // Apply zoom behavior to the SVG
    svg.call(zoom);

    // Resize listener for responsiveness
    window.addEventListener('resize', function() {
        map.resize();
    });

    </script>
</body>